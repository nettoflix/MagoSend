#ifndef CTRANSFERMONITOR_H
#define CTRANSFERMONITOR_H
#include <QThread>
#include <QTimer>
//#include "CHostControl.h"
#include "CMagoDBCommandsThread.h"
#include "CUploadServiceClient.h"
#include "Host.h"
#include "VideoFileInfo.h"
#include <QVector>
#include <QColor>
class MainWindow;
class CurrentUpload
{
public:
	CurrentUpload(QString name, QString ip): name(name), ip(ip)
	{}
	QString name;
	QString ip;
};
enum UploadFileStatus
{
	NO_ERROR = 0,
	NO_POSSIBLE_CONNECTION_TO_HOST = -1,
	CONNECTION_FAIL_WHILE_UPLOADING = -2,
	FILE_DOSENT_EXIST = -3,
	UPLOAD_SERVICE_IS_OUT = -4,
	THERE_IS_NO_UPLOAD_AT_THIS_MOMENT = -5,
	TRYING_TO_CONNECT_TO_HOST = -6,
	HOST_IS_BUSY = -7
};
class CHostControl;
//esse cara inicia de fato as transferencias dos hosts, armazena a queue com todas as informações dos arquivos, se comunica com o transfer local de cada host
//Da os comandos de envio e monitoração do progresso para os Transfers locais, verifica se houve erros etc
//é onde a maior lógica acontece
class CTransferMonitor : public QThread
{
Q_OBJECT


private:
    int failCounter;
	QMutex queueMutex;
	MainWindow* mainWindow;
	bool isTransferring = false;
	QVector<VideoFileInfo*> currentQueue;
	//bool isPopulatingQueue = false;
	QTimer* timer;
    QElapsedTimer timer_;
	QTimer* checkConnectionTimer;
    void stopTransferring();
	void run();
    void setErrorToUpload(VideoFileInfo* upload);
	private slots:
		void runLogic();

public:
	CTransferMonitor(MainWindow* mainWindow);
	~CTransferMonitor();
	QThread workerThread;
	void populateQueue(QString filePath, QString ip);
	void removeFromQueue(int row);
	void cancelActiveUpload(QString ip);
	void startUploads();
	void cancelUploads();
    bool isAlreadyInQueue(QString filepath, QString ip);

	QList<CurrentUpload> currentFilesUploading;
	MainWindow *getMainWindow() const;
	QMutex& getQueueMutex();
	VideoFileInfo* getItemFromQueue(QString fileName, QString ip);
	VideoFileInfo* getItemFromQueue(int index);
	QVector<VideoFileInfo*>& getCurrentQueue();
	int getProgress(QString ip, QString fileName);
signals:
		void showErrorMessage(QString error);
        void toggleEnviarTodosBtn(bool value);
        void restartService(Host* host);



};

#endif // CTRANSFERMONITOR_H
